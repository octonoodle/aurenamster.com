<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>edit launch</title>
    <script src="/client/load-defaults.js"></script>
    <script src="/client/load-menu-bar.js"></script>
    <style>
      label,
      p,
      option {
        display: inline-block;
        margin: 0.5em;
      }

      #yes-altitude,
      #no-altitude {
        display: inline-block;
        width: 50px;
      }
    </style>
  </head>
  <body>
    <h1>edit launch</h1>
    <form action="" method="post" id="main">
      <label for="time-input">launch time: </label>
      <input type="time" id="time-input" required /><br />
      <input type="hidden" name="time" id="time" />
      <label for="rocket-input">launched rocket: </label>
      <select id="rocket-input" required>
        <option value="rocket1">rocket1</option>
        <option value="rocket2">rocket2</option>
        <option value="rocket3">rocket3</option>
      </select>
      <input type="hidden" name="rocket" id="rocket">
      <br />
      <label for="motor_id">rocket motor: </label>
      <select name="motor_id" id="motor" required>
        <option value="motor1">motor1</option>
        <option value="motor2">motor2</option>
        <option value="motor3">motor3</option>
      </select>
      <br />
      <p>define altitude?</p>
      <div id="yes-altitude"><strong>yes</strong></div>
      <div id="no-altitude">no</div>
      <br />
      <label for="altitude_m">altitude (m): </label>
      <input type="number" id="altitude-input" value="0" required />
      <input type="hidden" name="altitude_m" id="altitude">
      <br />
      <button type="button" class="button-link" id="submit-button" onclick="formatSubmit()">
        submit
      </button>
      <input type="hidden" name="launch_id" />
    </form>
    <script>
      let params = new URLSearchParams(location.search);
      let launchID = params.get("id");
      let definedAltitude = true;
      $(document).ready(() => {
        setTimeout(() => {
          $('input[name="launch_id"]').val(launchID);
          $("form").attr("action", "/api/edit/launches/launch_id/" + launchID);
        }, 10);
        $(document).on("click", "#yes-altitude", () => {
          if (!definedAltitude) {
            $("#submit-button").before(
              '<label for="altitude_m">altitude (m): </label>'
            );
            $("#submit-button").before(
              '<input type="number" name="altitude_m" id="altitude-input" value=0 required/>'
            );
            $("#submit-button").before("<br />");
            $("#yes-altitude").html("<strong>yes</strong>");
            $("#no-altitude").html("no");
            definedAltitude = true;
          }
        });
        $(document).on("click", "#no-altitude", () => {
          if (definedAltitude) {
            $("#altitude-input").remove();
            $('label[for="altitude_m"]').remove();
            $("#submit-button").prev().remove(); // <br>
            $("#no-altitude").html("<strong>no</strong>");
            $("#yes-altitude").html("yes");
            definedAltitude = false;
          }
        });
        $.get("/api/read/match/launches/launch_id/" + launchID, (launches) => {
          $("form").append('<a href="" class="button-link">back</a>');
          $("a").attr(
            "href",
            launches[0]
              ? "/rocketry/archive/edit/launches?id=" + launches[0].session_id
              : "/rocketry/archive"
          );
          let launch = launches[0];
          if (launch) {
            // populate form with data
            $.get("/api/read/all/rockets", (rockets) => {
              $("#rocket-input").empty();
              for (rocket of rockets) {
                $("#rocket-input").append(
                  '<option value="' +
                    rocket.rocket_name +
                    '">' +
                    rocket.rocket_name +
                    "</option>"
                );
              }
            });
            $.get("/api/read/all/motors", (motors) => {
              $("#motor").empty();
              for (motor of motors) {
                $("#motor").append(
                  '<option value="' +
                    motor.motor_id +
                    '">' +
                    motor.motor_name +
                    "</option>"
                );
              }
            });
            // auto-select previous data
            setTimeout(function () {
              $("#time-input").val(launch.time);
              $("#rocket-input").val(launch.rocket);
              $("#motor").val(launch.motor_id);
            }, 10);
          }
        });
      });

      // bundle data for proper submission
      function formatSubmit() {
        $("#rocket").val($("#rocket-input").val());
        addEscapeChars("rocket");
        $("#time").val($("#time-input").val());
        addEscapeChars("time");
        if (definedAltitude) {
          $("#altitude").val($("#altitude-input").val());
        } else {
          $("#altitude").val('null');
        }
        document.getElementById("main").submit();
      }
    </script>
  </body>
</html>
