<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>meet the rockets</title>
    <script src="/client/load-defaults.js"></script>
    <script src="/client/load-menu-bar.js"></script>
    <link rel="stylesheet" href="/bloggish.css" />
    <style>
      section {
        display: flex;
        flex-flow: row wrap;
        justify-content: space-around;
        align-items: center;
        margin: 40px;
        width: calc(100vw - 80px);
      }

      info {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        width: clamp(300px, 40vw, 600px);
      }

      info p {
        max-width: 50vw;
      }

      info li:before {
        content: "";
        margin-left: -0.5rem;
      }

      .rocket-profile {
        display: flex;
        height: clamp(250px, 30vw, 400px);
        border: var(--border-width) solid var(--border-color);
      }
    </style>
  </head>
  <body>
    <h1>meet the rockets</h1>
    <p><h2 style="display: inline;">★</h2>: rocket is part of the main campaign</p>
    <!-- <section>
      <img src="/images/img-not-found.jpg" alt="" />
      <info>
        <h2><a src="/rocketry/archive/view?id=69">name</a></h2>
        <deets>
          <strong>built from: </strong>Dec 5, 1991<strong> to: </strong>Dec 28,
          1992
        </deets>
        <p>
          Lorem, ipsum dolor sit amet consectetur adipisicing elit. Repellendus,
          impedit? Aperiam accusamus perferendis beatae? Cum nostrum ad
          temporibus non molestiae accusamus ut vitae eos distinctio, voluptas
          mollitia, optio tenetur laboriosam tempore velit accusantium quod
          fugit aut exercitationem. Obcaecati, quaerat delectus nostrum
          incidunt, consectetur sed quisquam expedita minima qui, reprehenderit
          ratione?
        </p>
      </info>
    </section> -->
  </body>
  <script>
    $.get("/api/read/all/rockets", (rockets) => {
      rockets = rockets.filter((rock) => rock["visible?"]);
      rockets = rockets.sort((rock1, rock2) => {
        let date2 = new Date(rock1.build_date_end ?? "2224-01-01");
        let date1 = new Date(rock2.build_date_end ?? "2224-01-01");
        return date1.valueOf() - date2.valueOf();
      });

      for (rock of rockets) {
        let id = rock.rocket_name.split(/[^\w:\u00C0-\u00FF]/gm).join("-");
        $("body").append(`<section id="${id}"></section>`);
        $("#" + id).append(
          `<img class="rocket-profile" src="/meet-the-rockets/${id}.webp" onerror="this.src='/meet-the-rockets/unknown-rocket-orange.webp';" />`
        );
        $("#" + id).append("<info></info>");
        $("#" + id + " info").append(`<h2>${rock["flagship?"] ? '★ ' : ''}${rock.rocket_name}</h2>`);
        $("#" + id + " info").append("<deets></deets>");
        $("#" + id + " info").append("<p></p>");

        $("#" + id + " info p").append(rock.description);
        let start = niceDate(rock.build_date_start) ?? "???";
        let end = niceDate(rock.build_date_end) ?? "???";
        let deets = `<strong>built from:</strong> ${start} <strong>to:</strong> ${end}`;
        $("#" + id + " info deets").append(
          `<strong>built from:</strong> ${start}`
        );
        $("#" + id + " info deets").append(
          `&nbsp;&nbsp;&nbsp;<strong>finished:</strong> ${end}`
        );
        $("#" + id + " info deets").append(
          `<br><strong>method:</strong> ${rock.build_method}`
        );
        $("#" + id + " info deets").append(
          `&nbsp;&nbsp;&nbsp;<strong>mount size:</strong> ${rock.mount_diameter_mm} mm`
        );
        $("#" + id + " info deets").append(
          `<br><strong>status:</strong> ${
            rock.service_status ? rock.service_status : "unknown"
          }`
        );

        // calculate record altitude
        $.get(
          `/api/read/match/launches/rocket/'${rock.rocket_name.replace(
            "/",
            "%2f"
          )}'`,
          (launches) => {
            launches_defined = launches.filter((launch) => launch.altitude_m); // delete null launches
            launch_alts = launches_defined.map((launch) => launch.altitude_m);
            let max = "n/a";
            if (launches_defined.length > 0) {
              max = Math.max(...launch_alts);
              // console.log(launches);
              // console.log(max);
              max += " m";
            }
            $("#" + id + " info deets").append(
              `&nbsp;&nbsp;&nbsp;<strong>altitude record:</strong> ${max}`
            );

            // link to recent launch session
            if (launches.length > 0) {
              let session_ids = launches.map((launch) => launch.session_id);
              // remove duplicates
              session_ids = [...new Set(session_ids)];

              let sessions = new Array();
              let onSuccess = function () {
                // console.log(sessions);
                sessions = sessions.sort((sesh1, sesh2) => {
                  new Date(sesh1.date).getTime() >
                    new Date(sesh1.date).getTime();
                });
                // console.log(sessions);
                let newest_sesh = sessions[0];
                $("#" + id + " info deets").append(
                  `<br><strong>most recent launch:</strong> ${
                    newest_sesh
                      ? `<a href="/rocketry/archive/view?id=${
                          newest_sesh.session_id
                        }">${niceDate(newest_sesh.date)}</a>`
                      : "n/a"
                  }`
                );
                //$("#" + id + " info h2 a").attr("href", "/foo"); //'/rocketry/archive/view?id=' + sessions[0].session_id);
              };
              let reducer = (func_so_far, launch_session_id) =>
                $.get(
                  "/api/read/match/launch_sessions/session_id/" +
                    launch_session_id,
                  (results) => {
                    sessions.push(results[0]); // an id should only turn up one session object
                    // console.log("hi there");
                    // console.log(results[0]);
                    typeof func_so_far === "function"
                      ? func_so_far.call()
                      : func_so_far;
                  }
                );
              // overall: list-of id -> function
              // reducer: func, id -> func
              session_ids.reduce(reducer, onSuccess);
            }
          }
        );
      }
    });
  </script>
</html>
